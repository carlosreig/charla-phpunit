<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Introducción a PHPUnit - Drupal Day Bilbao 2014</title>

		<meta name="description" content="A framework for easily creating beautiful presentations using HTML">
		<meta name="author" content="Hakim El Hattab">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="css/reveal.min.css">
		<link rel="stylesheet" href="css/theme/beige.css" id="theme">

		<!-- For syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- If the query includes 'print-pdf', include the PDF print sheet -->
		<script>
			if( window.location.search.match( /print-pdf/gi ) ) {
				var link = document.createElement( 'link' );
				link.rel = 'stylesheet';
				link.type = 'text/css';
				link.href = 'css/print/pdf.css';
				document.getElementsByTagName( 'head' )[0].appendChild( link );
			}
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->

        <style>
            .reveal pre {
                text-align: center;
            }
            .reveal pre > code {
                text-align: justify;
            }

            .small {
                font-size: 0.2em !important;
            }

        </style>
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
					<h1>Introducción a PHPUnit</h1>
				
					<p>
						<small> <a href="http://www.carlosreig.es">Carlos Reig Matut</a> / <a href="http://www.twitter.com/unstatu">@unstatu</a></small>
					</p>
				</section>

                <section>
                    <h2>¿Quién soy?</h2>

                    <ul style="list-style: none; text-align: right; margin-top: 50px;">
                        <li>Carlos Reig Matut</li>
                        <li>Ingeniero informático por la UV</li>
                        <li>Freelance web developer</li>
                        <li><a href="http://www.twitter.com/unstatu">@unstatu</a></li>
                        <li><a href="mailto:unstatu@gmail.com">unstatu@gmail.com</a></li>
                    </ul>
                    <img style="float:right; margin-left: 30px" src="img/fotoPresentacion.jpg">

                    <ul style="list-style: none; float: left; margin-top: 100px;">
                        <li><img style="margin: 0; border: 0" src="img/logoAED.png"></li>
                        <li><a href="http://asociaciondrupal.es/">http://asociaciondrupal.es/</a></li>
                    </ul>
                </section>

                <section>
                    <h2>¿Qué es PHPUnit?</h2>
                    <p>PHPUnit es un framework orientado a objetos para realizar testing en PHP.</p>
                    <aside class="notes">
                            12 632 installs
                    </aside>
                </section>

                <section>
                    <section>
                        <h2>Entonces... ¿Qué es testing?</h2>
                        <p>Testing, en este caso, es automatizar el proceso de comprobar que las cosas funcionan como hemos pensado que lo hagan.</p>

                        <aside class="notes">
                            También hay testing manual...
                        </aside>
                    </section>
                    <section>
                        <h2>Tipos de testing</h2>
                        <ul>
                            <li><strong>Test unitario</strong></li>
                            <li>Test de integración</li>
                            <li>Test funcional</li>
                            <li>Test de aceptación</li>
                        </ul>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>¿Por qué es bueno tener tests?</h2>
                        <ul>
                            <li>Facilita refactorizar el código</li>
                            <li>Ayuda a tener un buen diseño</li>
                            <li><strong>Sirve para documentar el código</strong></li>
    			<li>Permite identificar rápidamente qué está fallando</li>
                            <li>...</li>
                        </ul>

                        <aside class="notes">
                            Permite el TDD. También da una sensación de seguridad, aunque tampoco está bien del todo...
                        </aside>
                    </section>
                    <section>
                        <h1>F<span class="small">ast</span>I<span class="small">solated</span>R<span class="small">epeateble</span>S<span class="small">elf-verifying</span>T<span class="small">imely</span></h1>
                    </section>

                </section>

                <section>
                    <h2>Instalación y ejecución</h2>
                    <ul>
                        <li>Puedes instalarlo mediante composer
			<pre><code>{
    "require-dev": {
        "phpunit/phpunit": "4.4.*"
    }
}</code></pre></li>
                        <li>Normalmente se ejecutan por línea de comandos:
                            <pre>php ./vendor/bin/phpunit</pre>
                        </li>
                    </ul>
                </section>

                <section>
                    <img src="img/PHPunit-terminal.png">
                </section>

                <section>
                    <h2>Las suites</h2>
                    <ul>
                        <li>Se compone de <em>test cases</em></li>
                        <li><strong>Un <em>test case</em> es una clase</strong> que hereda de <code>\PHPUnit_Framework_TestCase</code></li>
                    </ul>
                </section>

                <section>
                    <h2>Los test cases</h2>
                    <ul>
                        <li>Es una <strong>clase</strong>: métodos y atributos</li>
                        <li>Si un test tiene <strong>algún</strong> assert que no se cumpla, el test falla.</li>
                        <li>Los tests son los métodos públicos que empiezan por "test": <pre><code>public function testSiEstaClaro() { $this->assertTrue( true ); }</code></pre></li>
                        <li>Dos métodos especiales:
                            <ul>
                                <li><code>protected function setUp()</code></li>
                                <li><code>protected function tearDown()</code></li>
                            </ul>
                        </li>
                    </ul>
                    <p style="margin-top: 50px">Básicamente, un test se divide en <strong>tres fases</strong>...</p>
                    <aside class="notes">
                        Si el método es público pero no empieza por test, se puede indicar a PHPUnit que debe ejecutarlo añadiendo la anotación @test al PHPDoc
                        Normalmente el nombre del test case (el de la clase) es el nombre de la clase que está testeando + Test
                    </aside>
                </section>

                <section>
                    <h3>1. Preparar el test</h3>
                    <h3>2. Actuar</h3>
                    <h3>3. Comprobar si el resultado es el esperado (con asserts)</h3>
                    <aside class="notes">
                        Acción y efecto de afirmar o dar por cierto algo.

                        Un test falla si una aserción no se cumple.
                        Comprobar si el resultado es el esperado no significa que siempre tengamos que comprobar el valor devuelto del método que testeamos.
                        Puede ser comprobar que se ha pasado un argumento concreto a otro método, que un archivo se ha creado, etc.
                    </aside>
                </section>

                <section>
                    <pre><code class="php">$this->config = array(
    'one' => '1',
    'two' => '2',
);
$this->settings = new Settings($this->config);
...
$this->assertEquals($this->config['one'], Settings::get('one'));
$this->assertEquals($this->config['two'], Settings::get('two'));
                    </code>Drupal\Tests\Core\Site\SettingsTest::testGet</pre>
                </section>

                <section>
                    <pre><code class="php">//Preparar
$this->config = array(
    'one' => '1',
    'two' => '2',
);

//Actuar
$this->settings = new Settings($this->config);
$settingOne = Settings::get('one');
$settingTwo = Settings::get('two');
...
//Comprobar
$this->assertEquals($this->config['one'], $settingOne);
$this->assertEquals($this->config['two'], $settingTwo);
                    </code>Drupal\Tests\Core\Site\SettingsTest::testGet</pre>
                </section>

                <section>
                    <h2>Nos ponemos en contexto</h2>
                    <p>Nuestra aplicación es una calculadora de impuestos:
                        <ul>
                            <li>3 Clases: Calculadora, Factura y Cliente</li>
                            <li>Cada factura tiene que tener un identificador único autogenerado</li>
                            <li>Algunos clientes pueden tener descuentos especiales</li>
                            <li>La calculadora debe poder almacenar y eliminar facturas.</li>
                            <li>La calculadora debe poder obtener el total del dinero bruto y neto que hay en las facturas almacenadas</li>
                        </ul>
                    </p>
                </section>

                <section>
                    <h1>Manos a la obra</h1>
                </section>

                <section>
                    <section>
                        <h2>Fixtures</h2>
                        <p>Cuando escribes un test necesitas empezar en un estado conocido. Este estado es la fixture del test.<p>
                        <p>Se suele hacer en el <code>setUp</code> del test case</p>
                        <aside class="notes">
                            Ejemplo de la pila
                        </aside>
                    </section>

                    <section>
                        <pre><code>public function setUp() {
        $this->oTrimesterCalculator = new TrimesterTaxCalculator();
        $this->oClient = new Client( 'Obi Wan', 'Kenobi' );
}
public function testIfItAcceptsInvoices() {..}
public function testIfItRemovesInvoices() {..}</code></pre>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>Asserts</h2>
                        <p>Hacen fallar el test si no se cumplen.</p>
                        <p>Hay 36 diferentes: <small>assertArrayHasKey, assertClassHasAttribute, assertClassHasStaticAttribute, assertContains, assertContainsOnly, assertContainsOnlyInstancesOf, assertCount, assertEmpty, assertEqualXMLStructure, assertEquals, assertFalse, assertFileEquals, assertFileExists, assertGreaterThan, assertGreaterThanOrEqual, assertInstanceOf, assertInternalType, assertJsonFileEqualsJsonFile, assertJsonStringEqualsJsonFile, assertJsonStringEqualsJsonString, assertLessThan, assertLessThanOrEqual, assertNull, assertObjectHasAttribute, assertRegExp, assertStringMatchesFormat, assertStringMatchesFormatFile, assertSame, assertStringEndsWith, assertStringEqualsFile, assertStringStartsWith, assertThat, assertTrue, assertXmlFileEqualsXmlFile, assertXmlStringEqualsXmlFile, assertXmlStringEqualsXmlString.</small></p>
                    </section>

                    <section>
                        <pre><code>class TrimesterTaxCalculatorTest extends \PHPUnit_Framework_TestCase {
    ...
    public function testIfItAcceptsInvoices() {            
            $oInvoice = new Invoice( $this->oClient, 1000 );
            $oInvoice2 = new Invoice( $this->oClient, 2000 );

            $this->oTrimesterCalculator->addInvoice( $oInvoice );
            $aInvoices = $this->oTrimesterCalculator->getInvoices();

            $this->oTrimesterCalculator->addInvoice( $oInvoice2 );
            $aInvoices2 = $this->oTrimesterCalculator->getInvoices();

            $this->assertCount( 1, $aInvoices );
            $this->assertEquals( 2, count( $aInvoices2 ) );
    }
    ...
}</code></pre>
                    </section>

                    <section>
                        <pre><code>class TrimesterTaxCalculatorTest extends \PHPUnit_Framework_TestCase {
    ...
    public function testIfItRemovesInvoices() {
        //preparar
        $oInvoice = new Invoice( $this->oClient, 1000 );
        $oInvoice2 = new Invoice( $this->oClient, 2000 );

        $this->oTrimesterCalculator->addInvoice( $oInvoice );
        $this->oTrimesterCalculator->addInvoice( $oInvoice2 );

        //actuar
        $this->oTrimesterCalculator->removeInvoice( $oInvoice );

        $aInvoices = $this->oTrimesterCalculator->getInvoices();

        //comprobar
        //$this->assertCount( 1, $aInvoices );
        $this->assertTrue( count( $aInvoices ) === 1 );
    }
    ...
}</code></pre>
                    </section>

                    <section>
                        <pre><code>class InvoiceTest extends \PHPUnit_Framework_TestCase {
    ...
    public function testIfItGeneratesUniqIdsForEachInvoice() {
        //preparar y actuar
        $oInvoice = new Invoice( $this->oClient, 1000 );
        $oInvoice2 = new Invoice( $this->oClient, 2000 );
        $oInvoice3 = new Invoice( $this->oClient, 3000 );

        $aInvoiceIds = array(
            $oInvoice->getId(),
            $oInvoice2->getId(),
            $oInvoice3->getId(),
        );

        $aUniqueIds = array_unique( $aInvoiceIds );
        //comprobar
        $this->assertEquals( $aInvoiceIds, $aUniqueIds );
    }
    ...
}</code></pre>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>Sobre los tests</h2>
                    </section>

                    <section>
                        <h2>@depends</h2>
                        <pre><code>class TrimesterTaxCalculatorTest extends \PHPUnit_Framework_TestCase {
    ...
    /**
     * @depends testIfItAcceptsInvoices
     */
    public function testIfItRemovesInvoices() {
        //preparar
        $oInvoice = new Invoice( $this->oClient, 1000 );
        $oInvoice2 = new Invoice( $this->oClient, 2000 );

        $this->oTrimesterCalculator->addInvoice( $oInvoice );
        $this->oTrimesterCalculator->addInvoice( $oInvoice2 );

        //actuar
        $this->oTrimesterCalculator->removeInvoice( $oInvoice );

        $aInvoices = $this->oTrimesterCalculator->getInvoices();

        //comprobar
        //$this->assertCount( 1, $aInvoices );
        $this->assertTrue( count( $aInvoices ) === 1 );
    }
    ...
}</code></pre>
                        <aside class="notes">
                            Los @depends se suelen usar para proveer de argumentos a otros tests. Si falla el test del cual dependen los demás, estos no se ejecutan.
                        </aside>
                    </section>

                    <section>
                        <h2>@dataProvider</h2>
                        <pre><code>class TrimesterTaxCalculatorTest extends \PHPUnit_Framework_TestCase {
    ...
    public function invoicesAndGrossIncomeProvider() {
        $oClient = new Client( 'Obi Wan', 'Kenobi' );

        return array(
            array( //first time
                array( //first argument
                    new Invoice( $oClient, 1000 )
                ),
                1000, //second argument
            ),
            array(//second time
                array(//first argument
                    new Invoice( $oClient, 1000 ),
                    new Invoice( $oClient, 2000 ),
                ),
                3000, //second argument
            ),
            array(//third time
                array(//first argument
                    new Invoice( $oClient, 1000 ),
                    new Invoice( $oClient, 2000 ),
                    new Invoice( $oClient, 3000 ),
                ),
                6000, //second argument
            ),
        );
    }

    /**
     * @dataProvider invoicesAndGrossIncomeProvider
     */
    public function testIfItGetsTheGrossIncome( $aInvoices, $nGrossIncome ) {
        foreach ( $aInvoices as $oInvoice ) {
            $this->oTrimesterCalculator->addInvoice( $oInvoice );
        }

        $this->assertEquals( $nGrossIncome, $this->oTrimesterCalculator->getGrossIncome() );
    }
    ...
}</code></pre>
                        <aside class="notes">
                            Con los @dataProviders puedes ejecutar varias veces un test con distintos argumentos.
                        </aside>
                    </section>
                    <section>
                    <h2>@dataProvider</h2>
                        <pre><code>class InvoiceTest extends \PHPUnit_Framework_TestCase {
    ...
    public function differentClientsProvider() {
        return array(
            array( //first time
                new Client( 'Obi Wan', 'Kenobi' ), //first arg
                0 //second arg
            ),
            array( //second time
                new Client( 'Luke', 'Skywalker', 0.5 ), //first arg
                0.5 //second arg
            )

        );
    }

    /**
     * @dataProvider differentClientsProvider
     */
    public function testIfItAppliesCorrectlyTheDiscountToTheClients( $oClient, $nDiscount ) {
        $nGrossAmount = 1000;
        $oInvoice = new Invoice( $oClient, $nGrossAmount );

        $nAmountAfterTaxes = $nGrossAmount * ( 1 - Invoice::DEFAULT_TAXES );
        $nAmountAfterDiscount = $nAmountAfterTaxes * ( 1 - $nDiscount );

        $this->assertEquals( $nAmountAfterDiscount, $oInvoice->getNet() );
    }
    ...
}</code></pre>
                    </section>

                    <section>
                        <h2>@expectedException</h2>
                        <pre><code>class TrimesterTaxCalculatorTest extends \PHPUnit_Framework_TestCase {
    ...
    /**
     * @expectedException TaxCalculator\Exception\InvoiceNotFound
     */
    public function testIfItThrowsAnExceptionIfTheInvoiceDoesNotExist() {
        $oInvoice = new Invoice( $this->oClient, 1000 );

        $this->oTrimesterCalculator->removeInvoice( $oInvoice );
    }
    ...
}</code></pre>
                        <aside class="notes">
                            También se puede comprobar la salida del script o los errores de PHP.
                        </aside>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>Mocks/Stub</h2>
                        <p>Un mock es un objeto de mentira.</p>
                    </section>
                    <section>
                        <img src="img/rajoy.jpg" />
                    </section>
                    <section>
                        <h2>Con un mock puedes:</h2>
                        <ul>
                            <li>Comprobar si un método se ha llamado</li>
                            <li>Comprobar con qué argumentos se ha llamado</li>
                            <li>Modificar el comportamiento del método (sino se modifica, devuelve null por defecto)</li>
                            <li>Testear clases que tienen dependencias o interacciones con otras: <strong>INYECCIÓN DE DEPENDENCIAS</strong></li>
                            <li>...</li>
                        </ul>
                    </section>
                    <section>
                        <h2>Cómo usar un mock</h2>
                        <pre><code>//Creamos el mock
$oMock = $this->getMock('Clase_a_la_que_falsear');

//Cambiamos su comportamiento o hacemos comprobaciones
$oMock->expects( número_de_llamadas_esperadas )
->method( 'metodo_que_vigilar' )
->will( valor_a_devolver );
                        </code></pre>
                    </section>
                    <section>
                        <pre><code>class TrimesterTaxCalculatorTest extends \PHPUnit_Framework_TestCase {
    ...
    public function testIfItGetsTheNetIncome() {

        $mInvoice1 = $this->getInvoiceMock( $this->oClient, 1000 );
        $mInvoice2 = $this->getInvoiceMock( $this->oClient, 2000 );

        $mInvoice1->expects( $this->once() )
            ->method( 'getNet' )
            ->willReturn( 5 );

        $mInvoice2->expects( $this->exactly( 1 ) )
            ->method( 'getNet' )
            ->willReturn( 10 );

        $this->oTrimesterCalculator->addInvoice( $mInvoice1 );
        $this->oTrimesterCalculator->addInvoice( $mInvoice2 );

        $this->assertEquals( 15, $this->oTrimesterCalculator->getNetIncome() );
    }

    protected function getInvoiceMock( Client $oClient, $nGrossAmount ) {
        return $this->getMock( 'TaxCalculator\Invoice', array( 'getNet' ), array( $oClient, $nGrossAmount ) );
    }
    ...
}</code></pre>
                    </section>
                </section>
                <section>
                    <section>
                        <h2>PHPUNIT.xml</h2>
                        <ul>
                            <li>Indica de cuáles son las suites y en qué directorios están los tests</li>
                            <li>Permite cambiar algunos valores de la configuración de PHP</li>
                            <li><strong>Permite indicar un archivo de bootstrap</strong></li>
                        </ul>
                    </section>
                    <section>
                        <pre><code><?xml version="1.0" encoding="UTF-8"?>
<phpunit
        backupGlobals = "false"
        backupStaticAttributes = "false"
        colors = "true"
        convertErrorsToExceptions = "true"
        convertNoticesToExceptions = "true"
        convertWarningsToExceptions = "true"
        processIsolation = "false"
        stopOnFailure = "true"
        syntaxCheck = "false"
        bootstrap   = "bootstrap.php">
    <testsuites>
        <testsuite name="Tax Calculator">
            <directory>tests/</directory>
        </testsuite>
    </testsuites>

</phpunit></code>./phpunit.xml</pre>
                    </section>
                </section>
            <section>
                <h2>PHPUnit y xDebug</h2>
            </section>
            <section>
                <img src="img/esoEsTodoAmigos.jpg" />
            </section>
            </div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.min.js"></script>

		<script>

            Reveal.initialize({
                controls: true,
                progress: true,
                history: true,
                center: true,

                theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
                transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

                // Parallax scrolling
                // parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
                // parallaxBackgroundSize: '2100px 900px',

                // Optional libraries used to extend on reveal.js
                dependencies: [
                    { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
                    { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
                    { src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
                    { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
                ]
            });

		</script>

	</body>
</html>
